#+TITLE: 资金管理
#+AUTHOR: 胡琛

* 凯利公式

** 推导

   #+BEGIN_QUOTE
   假设有一个赌局，每投入 1，有 $p$ 的概率获得额外正收益 $W$ ，有 $q=1-p$ 的概率获得额外负收益 $-L$,
   每次投入比例为 $x$, 收益为 $f(x)$, 目标是期望收益最大化。
   #+END_QUOTE

   1. 将问题转为规划问题：

        \begin{equation} \label{eq:01}
          \begin{array}{l}
            \max f(x) = (1+Wx)^p(1-Lx)^q\\
            s.t.\ 0\leq x \leq 1
          \end{array}
        \end{equation}
        
   2. 对式 ref:eq:01 求导，则有：

        \begin{equation} \label{eq:02}
          \begin{array}{l}
            f^{\prime}(x) = Wp(1+Wx)^{p-1}(1-Lx)^q-L(1-p)(1+Wx)^p(1-Lx)^{q-1} = 0\\
            Wp(1+Wx)^{-1}f(x)-L(1-p)(1-Lx)^{-1}f(x) = 0
          \end{array}
        \end{equation}

   3. 当 $f(x)\neq 0$ 有 $Wp(1-Lx) = Lq(1+Wx)$, 即 $x=\frac{Wp-Lq}{WL}=\frac{bp-q}{bL}$, 这里，
      $b = \frac{W}{L}$.

** 应用
      
* 多种资金管理方法

** 固定分数法

*** 方法描述

    建立在单笔合约地亏损额即为该系统止损额基础之上，用资金总额 $f\%$ 作为我们地风险资金，用该数值
    除以我们设定地止损值，即可得到我们能买进的合约数。

*** 举例
     
    假设我们有 100000 欧元，可承受风险比例为 $5\%$, 风险资金即为 5000 欧元，假设系统的止损金额是
    1250 欧元，那么，每笔合约可买进 $5000/1250=4$ 份合约。每次交易后，都需要重新计算可买进的合约
    数是多少。
     
    1. 下表为 10 次交易后资金额的变化
       #+NAME: 表1
       [[file:tbl1.png]]
    2. 下表为不同风险对应10次交易后金额变化，可以看出风险敞口大的时候，对应收益也大，但是，并不是
       风险敞口放的越大，收益就会越多，下表表明 $25\%$ 的风险收益比 $50\%$ 的风险收益更多
       #+NAME: 表2
       [[file:tbl2.png]]

*** 说明

    风险比例并非系统资金亏损额的衡量单位，系统资金亏损额由交易次序控制，举例而言：如果我们设置的止
    损金额是 1250 欧元，但是如果每次交易都是亏损 500 欧元，并不会触发我们的止损，而且，如果出现
    极端情况，即连续很多次都亏损，但是亏损额度都在 1250 欧元之内，那么，系统总金额很可能减少到无法
    进行交易的情况。
     
    - 一种极端情况
      如果我有 10000 欧元，我能够承受 $25\%$ 的风险比例，每张合约我能承受 $1250\%$ 欧元的损失，
      那么，我一开始，可以买入 $10000*0.25/1250=2$ 张合约，之后如果第一次买入，我每张合约亏损
      1000 欧元，此时，我的资金账户仅剩 9000 欧元，而且并不会触发我的止损，那么，第二次我可以
      买入的合约数为 $9000*0.25/1250 = 1$ 手合约 (往最接近分数的比较小的整数取整)；如果这样
      的情况连续出现，一直到我的账户甚至亏损光了，或者譬如只剩 1000 欧元的时候，此时，连一张合约
      我都买不起。因此，风险比例并非系统资金亏损额的衡量单位。
    - 如果将风险比例定为 $f\%$, 可以确定的是，资金减少的比例至少为 $f$, 虽然这并非绝对；实际上，当
      交易的亏损额刚好为所设定的止损数额时，就会损失所有资金的 $f\%$.
    - 亏损交易出现很可能时因为对系统处理不当，更有可能是 “回撤率” 所致。也就是说，我们本金达到相对
      最大值的时候，再次跌落的情况。

** 最优 f 值法
   
   由拉尔夫 $\cdot$ 文斯提出，他认为，如果交易不是以利润最大化为目的，是非常不理智的。为了计算最优
   f 值，拉尔夫 $\cdot$ 文斯考虑了系统进行过的所有交易，如果一个系统最大亏损额是 1200 欧元，那么
   600 欧元的亏损额即表示 0.5, 1800 欧元的收益率为 -1.5.
   
*** 专业术语

    - Pn：第 n 次交易所得利润
    - HPRn (第n次交易收益率)： 第 n 次交易资本的收益增值率
    - WCS (最坏的情况)： 最大亏损额
    - TWR (最终收益相关值)： 所有交易之后的最终资本与初始资本相比的增值收益率
    - f： 每次交易的风险比例

*** 使用公式

      \begin{eqnarray}
        HPRn &=& 1-f\times (Pn/WCS)\\
        TWR &=& HPR1\times HPR2\times HPR3\times \ldots \times HPRn
      \end{eqnarray}

*** 公式解释
     
